# 要件定義書：Discord会議 自動議事録生成システム


## 1. プロジェクト概要

### 1.1 目的
Discord音声チャンネルでの会議を自動的に録音・文字起こし・議事録生成し、指定チャンネルへ投稿するシステムを構築する。

### 1.2 ゴール
Craig Botによる録音終了をトリガーに、人手を介さず議事録が生成・投稿される完全自動パイプラインを実現する。

---

## 2. システム構成

```
┌──────────────┐     ┌──────────────┐     ┌──────────────┐     ┌──────────────┐     ┌──────────────┐
│  Craig Bot   │────▶│  音声取得    │────▶│  文字起こし  │────▶│  議事録生成  │────▶│ Discord投稿  │
│ (マルチトラ  │     │ (DLリンク    │     │(faster-whisper│     │ (Claude API) │     │ (要約+ファイ │
│  ック録音)   │     │  検知&取得)  │     │  large-v3)   │     │              │     │  ル添付)     │
└──────────────┘     └──────────────┘     └──────────────┘     └──────────────┘     └──────────────┘
```

### 2.1 技術スタック（推奨）

| レイヤー | 技術 | 選定理由 |
|---------|------|---------|
| 録音 | Craig Bot (既存) | マルチトラック録音を無料で提供。自前実装不要 |
| パイプライン制御 | Discord Bot (Python / discord.py) | Craig のメッセージ検知・ファイルDL・投稿を一元管理 |
| 音声前処理 | FFmpeg | Craig の FLAC/Ogg → WAV 変換、話者別トラックの統合 |
| 文字起こし | faster-whisper (large-v3) ローカル実行 | API費用$0、精度はWhisper APIと同等、CUDA対応で高速 |
| 議事録生成 | Claude API (Sonnet) | 日本語の要約・構造化能力が高い、コストパフォーマンス良好 |
| ホスティング | ローカルPC | コスト最小、セットアップ簡単 |

---

## 3. 機能要件

### 3.1 録音（Craig Bot 連携）

| 項目 | 内容 |
|-----|------|
| 録音方式 | Craig Bot のマルチトラック録音を利用 |
| 録音開始 | ユーザーが手動で `/join` コマンドを実行（既存運用を踏襲） |
| 録音終了 | ユーザーが手動で `/stop` または `/leave` を実行 |
| 出力形式 | 話者別の個別音声ファイル（FLAC または Ogg） |
| 対象 | 1サーバー・1音声チャンネル |

### 3.2 録音終了検知とファイル取得

| 項目 | 内容 |
|-----|------|
| トリガー | Craig Bot が投稿するダウンロードリンクメッセージを自動検知 |
| 検知方法 | 自作 Discord Bot が Craig Bot のメッセージ（Bot ID / embed 内容）を監視 |
| ファイル取得 | Craig のダウンロード URL から話者別音声ファイルを自動ダウンロード |
| 保存先 | サーバーの一時ディレクトリ（処理完了後に自動削除） |

**備考**: Craig Bot はEnnuicastri（Web録音）とDiscord録音の2つのモードがある。Discord録音の場合、録音終了後にテキストチャンネルにダウンロードリンクが投稿される。このリンクには有効期限がある（通常7日間、Craig Premium で延長可）ため、速やかにダウンロードする必要がある。

### 3.3 音声前処理

| 項目 | 内容 |
|-----|------|
| フォーマット変換 | FLAC/Ogg → WAV（faster-whisper の入力形式に合わせる） |
| 無音除去 | 話者トラック内の長時間無音区間をトリミング（任意、処理時間短縮に有効） |
| ファイル分割 | 不要（ローカル実行のためファイルサイズ制限なし） |

### 3.4 文字起こし（faster-whisper ローカル実行）

| 項目 | 内容 |
|-----|------|
| 入力 | 話者別の音声ファイル（WAV） |
| エンジン | faster-whisper（CTranslate2ベース、本家Whisperより約4倍高速） |
| モデル | large-v3 |
| 実行環境 | ローカル GPU（NVIDIA、VRAM 6GB以上、CUDA使用） |
| 処理方式 | 話者ごとに順次処理（VRAM制約のため並列は非推奨） |
| 出力形式 | タイムスタンプ付きテキスト（セグメント単位） |
| 言語指定 | `language="ja"`（日本語固定） |
| 話者識別 | トラック = 話者なので diarization 不要（Craig の利点） |
| 処理速度目安 | 1時間音声 → 約5〜10分（GPU使用時） |

**話者名の解決**: Craig はファイル名に Discord ユーザー名を含めるため、これを話者ラベルとして使用する。

**必要なセットアップ**:
```bash
pip install faster-whisper
# CUDA Toolkit + cuDNN が事前に必要
# 初回実行時にモデル（約3GB）が自動ダウンロードされる
```

### 3.5 トランスクリプト統合

| 項目 | 内容 |
|-----|------|
| 処理内容 | 話者別の文字起こし結果をタイムスタンプで時系列にマージ |
| 出力形式 | 統合トランスクリプト（以下のフォーマット） |

```
[00:00:15] 田中: プロジェクトの進捗について報告します。
[00:00:32] 鈴木: はい、先週のタスクは完了しました。
[00:01:05] 田中: ありがとうございます。次のマイルストーンについてですが...
```

### 3.6 議事録生成（LLM）

| 項目 | 内容 |
|-----|------|
| 入力 | 統合トランスクリプト（タイムスタンプ＋話者ラベル付き） |
| LLM | Claude API（claude-sonnet-4-5-20250929 推奨） |
| 出力 | 構造化された議事録 |

**議事録の構成**:

```markdown
# 会議議事録
- 日時: 2026-02-07 14:00〜15:00
- 参加者: 田中、鈴木、佐藤
- 録音時間: 58分

## 要約（3〜5行）
本会議では...

## アジェンダ / 議題
1. プロジェクト進捗報告
2. 次期マイルストーンの確認
3. リスク事項の共有

## 議論の詳細
### 1. プロジェクト進捗報告
- 田中より現状報告。先週のスプリントは計画通り完了。
- 鈴木がバックエンドの改修状況を補足。
  ...

## 決定事項
- [ ] ○○の期限を2/14に設定（担当: 鈴木）
- [ ] △△のレビューを来週月曜に実施（担当: 佐藤）

## 次回アクション / TODO
| 担当 | タスク | 期限 |
|------|--------|------|
| 鈴木 | ○○の実装完了 | 2/14 |
| 佐藤 | △△のレビュー | 2/10 |

## 懸念事項・リスク
- ...
```

### 3.7 Discord 投稿

| 項目 | 内容 |
|-----|------|
| 投稿先 | 指定されたテキストチャンネル（設定で変更可能） |
| 投稿形式① | **要約メッセージ**（Embed形式）：会議タイトル、日時、参加者、要約3〜5行、決定事項 |
| 投稿形式② | **詳細ファイル**（Markdown）：フル議事録をファイル添付 |
| 投稿タイミング | 全処理完了後に自動投稿 |
| エラー時 | 処理失敗時はエラーメッセージを投稿し、管理者にメンション |

**Embed メッセージ例**:
```
📋 会議議事録 — 2026/02/07
━━━━━━━━━━━━━━━━━━
👥 参加者: 田中、鈴木、佐藤
⏱️ 58分

📝 要約
プロジェクトの進捗確認と次期マイルストーンの設定を行った。
主要タスクの期限を2/14に決定。

✅ 決定事項
・○○の期限を2/14に設定（担当: 鈴木）
・△△のレビューを来週月曜に実施（担当: 佐藤）

📎 詳細議事録は添付ファイルを参照
```

---

## 4. 非機能要件

### 4.1 パフォーマンス

| 項目 | 目標値 |
|-----|-------|
| 処理時間 | 録音終了から投稿完了まで 15分以内（1時間会議・GPU使用時） |
| 同時処理 | 1件（1サーバー・1チャンネルのため） |

### 4.2 信頼性

| 項目 | 内容 |
|-----|------|
| リトライ | API呼び出し失敗時に最大3回リトライ（指数バックオフ） |
| エラー通知 | 処理失敗時は指定チャンネルにエラー内容を投稿 |
| ログ | 各処理ステップのログを保存（デバッグ用） |
| 一時ファイル管理 | 処理完了後に音声ファイル・中間ファイルを自動削除 |

### 4.3 セキュリティ

| 項目 | 内容 |
|-----|------|
| APIキー管理 | 環境変数で管理（`.env` ファイル、Git管理外） |
| 音声データ | 処理完了後にサーバーから削除。外部APIへの送信は最小限 |
| Bot権限 | 必要最小限のDiscord権限のみ付与 |

### 4.4 コスト見積もり（1時間会議/月4回の場合）

| 項目 | 単価 | 月額概算 |
|-----|------|---------|
| Craig Bot | 無料（Free tier） | $0 |
| faster-whisper (ローカル) | 無料 | $0 |
| Claude API (Sonnet) | ~$3/100万入力トークン | ~$0.50（トランスクリプト量に依存） |
| ホスティング | ローカルPC | $0 |
| **合計** | | **~$0.50/月** |

---

## 5. 設定・カスタマイズ

Bot の設定ファイル（`config.yaml` 等）で以下を変更可能にする。

```yaml
# config.yaml
discord:
  bot_token: ${DISCORD_BOT_TOKEN}      # 環境変数から
  guild_id: "123456789"                 # 対象サーバーID
  watch_channel_id: "123456789"         # Craigのメッセージを監視するチャンネル
  output_channel_id: "987654321"        # 議事録を投稿するチャンネル
  error_mention_role: "管理者"           # エラー時にメンションするロール

craig:
  bot_id: "272937604339466240"          # Craig Bot のユーザーID
  download_timeout: 300                 # ダウンロードタイムアウト（秒）

whisper:
  model: "large-v3"                     # large-v3 / medium / small
  language: "ja"
  device: "cuda"                        # cuda or cpu
  compute_type: "float16"               # float16(GPU) / int8(CPU) / float32

llm:
  provider: "anthropic"                 # anthropic or openai
  api_key: ${ANTHROPIC_API_KEY}
  model: "claude-sonnet-4-5-20250929"
  prompt_template: "prompts/minutes.txt" # 議事録生成プロンプト

output:
  embed_color: 0x5865F2                 # Embedの色
  include_transcript: false             # 生トランスクリプトも添付するか
  max_embed_length: 2000                # Embed要約の最大文字数
```

---

## 6. 処理フロー詳細

```
1. [待機] Bot が指定チャンネルで Craig Bot のメッセージを監視
       │
2. [検知] Craig Bot のダウンロードリンクメッセージを検出
       │  ├─ Bot ID の一致を確認
       │  └─ ダウンロード URL をパース
       │
3. [取得] 音声ファイルをダウンロード
       │  ├─ マルチトラック ZIP/個別ファイルを取得
       │  ├─ 話者名（ファイル名から抽出）を記録
       │  └─ 一時ディレクトリに保存
       │
4. [前処理] FFmpeg で音声を変換・最適化
       │  ├─ FLAC/Ogg → WAV 変換
       │  ├─ 必要に応じてチャンク分割（25MB上限対応）
       │  └─ 無音区間のトリミング（オプション）
       │
5. [文字起こし] 話者別に faster-whisper (large-v3) で処理
       │  ├─ 各話者トラックを順次処理（GPU VRAM 制約）
       │  └─ タイムスタンプ付きセグメントを取得
       │
6. [統合] 話者別結果をタイムスタンプでマージ
       │  └─ 時系列順の統合トランスクリプトを生成
       │
7. [生成] 統合トランスクリプトを LLM に送信
       │  ├─ 議事録プロンプトテンプレート + トランスクリプト
       │  └─ 構造化された議事録（Markdown）を取得
       │
8. [投稿] Discord に結果を投稿
       │  ├─ Embed メッセージ（要約）を送信
       │  └─ Markdown ファイル（詳細議事録）を添付
       │
9. [後処理] 一時ファイルを削除、ログを記録
```

---

## 7. ホスティング環境

**ローカルPC で運用する。**

| 項目 | 内容 |
|-----|------|
| 実行環境 | ローカルPC（Windows / Mac / Linux） |
| 月額コスト | ¥0（電気代・API費用のみ） |
| プロセス管理 | OS起動時に Bot を自動起動（後述） |
| 前提 | 会議が行われる時間帯にPCが起動・ネット接続されていること |

### 7.1 自動起動の設定

| OS | 方法 |
|----|------|
| Windows | タスクスケジューラでログイン時に `pythonw bot.py` を起動 |
| Mac | LaunchAgent（plist）でログイン時に起動 |
| Linux | systemd ユーザーサービスで自動起動 |

### 7.2 ローカル運用時の注意点

- **PCスリープ対策**: 会議中にPCがスリープすると Bot が切断される。電源設定でスリープを無効化するか、会議時間帯のみスリープ抑制する
- **再起動時の復帰**: OS再起動後に Bot が自動起動するよう設定しておく
- **ネットワーク**: Craig のファイルダウンロード（数百MB）と API 通信が発生するため、安定した回線が必要

---

## 8. 前提条件・制約

| 項目 | 内容 |
|-----|------|
| Craig Bot のアカウント | 対象サーバーに Craig Bot が導入済みであること |
| Craig Bot の仕様変更リスク | Craig のダウンロードURL形式や投稿形式が変更された場合、パーサーの修正が必要 |
| Whisper API の制限 | ファイルサイズ上限 25MB、対応形式: mp3, mp4, mpeg, mpga, m4a, wav, webm |
| GPU 要件 | NVIDIA GPU（VRAM 6GB以上）、CUDA Toolkit、cuDNN がインストール済みであること |
| Discord Embed の制限 | Embed の description は最大4096文字、フィールド数は最大25 |
| Discord ファイル添付の制限 | 通常 25MB まで（Nitro で 500MB）。議事録 Markdown は十分小さいため問題なし |

---

## 9. 今後の拡張候補（スコープ外）

以下は初期リリースのスコープ外だが、将来的に検討可能な機能。

- 複数チャンネル / 複数サーバー対応
- 議事録のテンプレートカスタマイズ（Discordコマンドで変更）
- 文字起こし結果の手動修正UI（Web画面）
- 会議のカレンダー連携（Google Calendar 等）
- 過去の議事録検索機能
- 議事録の Notion / Google Docs 自動エクスポート
- 話者ごとの発言量・発言時間の可視化
- 日英混在対応（Whisper の `language` パラメータ動的切替）
- VPS / クラウドへの移行（PC常時稼働が難しくなった場合）

---

## 10. マイルストーン案

| フェーズ | 内容 | 目安期間 |
|---------|------|---------|
| Phase 1 | 環境構築・Bot 基盤（Craig メッセージ検知まで） | 1週間 |
| Phase 2 | 音声取得 → 文字起こしパイプライン実装 | 1週間 |
| Phase 3 | 議事録生成 → Discord 投稿の実装 | 1週間 |
| Phase 4 | 結合テスト・エラーハンドリング・デプロイ | 1週間 |
